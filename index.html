<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Weekly Shift Calendar</title>
  <style>
    :root {
      --bg: #0b0f14;
      --card: #11161d;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --border: #233043;
      --day: #a9dfbf;
      --evening: #f9e79f;
      --night: #aed6f1;
      --today: #334155;
    }
    body { margin: 0; font-family: system-ui, sans-serif; color: var(--text); background: linear-gradient(180deg, #0b0f14, #0e1420 45%, #0b0f14); }
    .wrapper { max-width: 1200px; margin: 32px auto; padding: 0 16px; }
    header { display: flex; flex-wrap: wrap; align-items: center; gap: 12px; margin-bottom: 16px; }
    h1 { font-size: clamp(20px, 3vw, 28px); margin: 0; }
    .sub { color: var(--muted); font-weight: 500; }
    .controls { display: flex; gap: 8px; margin-left: auto; }
    .btn { background: #1b2430; color: var(--text); border: 1px solid var(--border); padding: 8px 12px; border-radius: 10px; cursor: pointer; font-weight: 600; }
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 12px; }
    .day-col { background: var(--card); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; }
    .day-header { padding: 12px 10px; border-bottom: 1px solid var(--border); text-align: center; }
    .dow { font-weight: 800; }
    .date { font-size: 12px; color: var(--muted); }
    .blocks { position: relative; height: 560px; display: flex; flex-direction: column; }
    .shift { display: flex; flex-direction: column; justify-content: flex-start; align-items: stretch; text-align: center; padding: 4px; overflow: hidden; }
    .shift-header { font-weight: 800; font-size: 12px; color: #0b1320; text-shadow: 0 1px 0 rgb(255 255 255 / .35); margin-bottom: 4px; }
    .names-list { text-align: left; background: rgb(255 255 255 / 0.35); border-radius: 8px; padding: 6px 6px 4px; min-height: 40px; font-size: 13px; font-weight: 800; color: #0b1320; line-height: 1.25; }
    .names-list .name { display: block; }
    .shift.day { background: var(--day); }
    .shift.evening { background: var(--evening); }
    .shift.night { background: var(--night); }
    .today .day-header { outline: 2px solid var(--today); outline-offset: -2px; }

    /* Signup modal */
    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.45); z-index: 50; padding: 16px; }
    .modal.open { display: flex; }
    .dialog { width: min(900px, 96vw); background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; box-shadow: 0 20px 60px rgba(0,0,0,.5); }
    .dialog header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .dialog h2 { margin: 0; font-size: 18px; }
    .dialog .body { display: grid; grid-template-columns: 280px 1fr; gap: 12px; }
    .field { display: grid; gap: 6px; }
    .field label { font-size: 12px; color: var(--muted); }
    .input { background: #0f1622; color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; font-weight: 600; }
    .choices { max-height: 360px; overflow: auto; border: 1px solid var(--border); border-radius: 12px; padding: 8px; }
    .day-group { padding: 6px 6px 8px; border-bottom: 1px dashed var(--border); }
    .day-group:last-child { border-bottom: 0; }
    .day-title { font-weight: 800; color: var(--muted); margin-bottom: 6px; }
    .choice { display: flex; gap: 8px; align-items: center; margin: 4px 0; font-size: 13px; }
    .dialog footer { display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px; }
    .btn.secondary { background: #121a25; }
  </style>
</head>
<body>
  <div class="wrapper">
    <header>
      <h1>Weekly Shift Calendar</h1>
      <div id="range" class="sub"></div>
      <div class="controls">
        <button class="btn" id="prev">◀ Prev</button>
        <button class="btn" id="today">Today</button>
        <button class="btn" id="next">Next ▶</button>
        <button class="btn" id="signupBtn">✚ Sign up</button>
      </div>
    </header>

    <section id="calendar" class="calendar"></section>

    <!-- Signup Modal -->
    <div id="signupModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="signupTitle">
      <div class="dialog">
        <header>
          <h2 id="signupTitle">Sign up for extra shifts</h2>
          <button class="btn secondary" id="closeModal">✕</button>
        </header>
        <div class="body">
          <div class="field">
            <label for="nameInput">Your name</label>
            <input id="nameInput" class="input" placeholder="Type your name" />
            <small class="sub">You can select multiple days and shifts.</small>
          </div>
          <div class="choices" id="choices"></div>
        </div>
        <footer>
          <button class="btn secondary" id="cancelBtn">Cancel</button>
          <button class="btn" id="submitSignup">Add to selected shifts</button>
        </footer>
      </div>
    </div>
  </div>

  <script>
    const TZ = 'Europe/Oslo';
    const WEEKDAYS = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];

    const WEEKDAY_SHIFTS = [
      { name: 'Day Shift', type: 'day', start: '07:00', end: '15:00', hours: 8 },
      { name: 'Evening Shift', type: 'evening', start: '15:00', end: '23:00', hours: 8 },
      { name: 'Night Shift', type: 'night', start: '23:00', end: '07:00', hours: 8 },
    ];
    const WEEKEND_SHIFTS = [
      { name: 'Day Shift', type: 'day', start: '07:00', end: '19:00', hours: 12 },
      { name: 'Night Shift', type: 'night', start: '19:00', end: '07:00', hours: 12 },
    ];

    const fmt = new Intl.DateTimeFormat('en-GB', { timeZone: TZ, day: '2-digit', month: 'short', year: 'numeric' });
    const fmtShort = new Intl.DateTimeFormat('en-GB', { timeZone: TZ, day: '2-digit', month: 'short' });

    function addDays(date, days) { const d = new Date(date); d.setUTCDate(d.getUTCDate() + days); return d; }
    function getShifts(dayIndex) { return (dayIndex >= 1 && dayIndex <= 4) ? WEEKDAY_SHIFTS : WEEKEND_SHIFTS; }

    // --- Sign-up storage helpers ---
    // Use localStorage when available; fall back to an in-memory store so the UI still works in sandboxed browsers.
    const memoryStore = new Map();
    function key(dateISO, shiftType) { return `signup:${dateISO}:${shiftType}`; }
    function loadNames(dateISO, shiftType) {
      const k = key(dateISO, shiftType);
      try {
        const raw = localStorage.getItem(k);
        if (raw) return JSON.parse(raw);
      } catch (e) { /* ignore */ }
      return memoryStore.get(k) || [];
    }
    function saveNames(dateISO, shiftType, arr) {
      const k = key(dateISO, shiftType);
      try { localStorage.setItem(k, JSON.stringify(arr)); }
      catch (e) { memoryStore.set(k, arr); }
    }

    // Keep the currently rendered week data to build the modal choices
    let weekData = [];

    function renderNamesList(container, dateISO, shiftType) {
      const names = loadNames(dateISO, shiftType);
      if (!names.length) { container.innerHTML = '<em>No sign-ups yet</em>'; return; }
      container.innerHTML = names.map(n => `<span class="name">• ${n}</span>`).join('');
    }

    function render(offset = 0) {
      const today = new Date();
      const start = addDays(today, offset * 7);

      const calendarEl = document.getElementById('calendar');
      calendarEl.innerHTML = '';

      weekData = [];
      for (let i = 0; i < 7; i++) {
        const thisDay = addDays(start, i);
        const dow = WEEKDAYS[thisDay.getDay()];
        const label = fmt.format(thisDay);
        const dateISO = thisDay.toISOString().slice(0,10);

        const col = document.createElement('article');
        col.className = 'day-col';
        if (i === 0 && offset === 0) col.classList.add('today');

        const head = document.createElement('div');
        head.className = 'day-header';
        head.innerHTML = `<div class="dow">${dow}</div><div class="date">${label}</div>`;
        col.appendChild(head);

        const blocks = document.createElement('div');
        blocks.className = 'blocks';
        const shifts = getShifts(thisDay.getDay());

        const dayInfo = { dateISO, dow, label, shifts: [] };

        shifts.forEach(s => {
          const block = document.createElement('div');
          block.className = `shift ${s.type}`;
          block.style.height = `${(s.hours / 24) * 100}%`;
          block.dataset.date = dateISO;
          block.dataset.shift = s.type;

          const header = document.createElement('div');
          header.className = 'shift-header';
          header.innerHTML = `${s.name}<br>${s.start}–${s.end}`;
          block.appendChild(header);

          const list = document.createElement('div');
          list.className = 'names-list';
          renderNamesList(list, dateISO, s.type);
          block.appendChild(list);

          blocks.appendChild(block);

          dayInfo.shifts.push({ type: s.type, name: s.name, time: `${s.start}–${s.end}` });
        });

        col.appendChild(blocks);
        calendarEl.appendChild(col);
        weekData.push(dayInfo);
      }

      const range = document.getElementById('range');
      range.textContent = `${fmtShort.format(start)} – ${fmt.format(addDays(start,6))}`;
    }

    // Controls
    document.getElementById('prev').addEventListener('click', () => { render(-1); });
    document.getElementById('next').addEventListener('click', () => { render(1); });
    document.getElementById('today').addEventListener('click', () => { render(0); });

    // --- Signup modal logic ---
    const modal = document.getElementById('signupModal');
    const choicesEl = document.getElementById('choices');
    const nameInput = document.getElementById('nameInput');

    function openSignupModal() {
      // Build checkbox list from weekData
      choicesEl.innerHTML = '';
      weekData.forEach(day => {
        const group = document.createElement('div');
        group.className = 'day-group';
        const title = document.createElement('div');
        title.className = 'day-title';
        title.textContent = `${day.dow} — ${day.label}`;
        group.appendChild(title);

        day.shifts.forEach(s => {
          const id = `${day.dateISO}|${s.type}`;
          const row = document.createElement('label');
          row.className = 'choice';
          row.innerHTML = `<input type="checkbox" value="${id}"> <span>${s.name} (${s.time})</span>`;
          group.appendChild(row);
        });

        choicesEl.appendChild(group);
      });

      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
      setTimeout(() => nameInput.focus(), 0);
    }
    function closeSignupModal() {
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden', 'true');
    }

    document.getElementById('signupBtn').addEventListener('click', openSignupModal);
    document.getElementById('closeModal').addEventListener('click', closeSignupModal);
    document.getElementById('cancelBtn').addEventListener('click', closeSignupModal);

    document.getElementById('submitSignup').addEventListener('click', () => {
      const name = nameInput.value.trim();
      if (!name) { nameInput.focus(); return; }
      const checks = choicesEl.querySelectorAll('input[type="checkbox"]:checked');
      if (!checks.length) return;

      // Apply to each selected shift (unique per shift)
      const updates = [];
      checks.forEach(ch => {
        const [dateISO, shiftType] = ch.value.split('|');
        const arr = loadNames(dateISO, shiftType);
        if (!arr.includes(name)) arr.push(name);
        saveNames(dateISO, shiftType, arr);
        updates.push({ dateISO, shiftType, arr });
      });

      // Update visible lists instantly
      updates.forEach(({ dateISO, shiftType, arr }) => {
        document.querySelectorAll(`.shift[data-date="${dateISO}"][data-shift="${shiftType}"] .names-list`).forEach(list => {
          list.innerHTML = arr.length ? arr.map(n => `<span class=\"name\">• ${n}</span>`).join('') : '<em>No sign-ups yet</em>';
        });
      });

      nameInput.value = '';
      closeSignupModal();
    });

    // Initial render
    render(0);

    // -----------------
    // Basic sanity tests (console)
    // -----------------
    (function runTests(){
      try {
        console.groupCollapsed('%cShift Calendar Tests','color:#10b981');
        console.assert(getShifts(1).length === 3 && getShifts(4).length === 3, 'Weekday shifts should be 3 blocks');
        console.assert(getShifts(0).length === 2 && getShifts(6).length === 2, 'Weekend shifts should be 2 blocks');
        const cols = document.querySelectorAll('.day-col').length; console.assert(cols === 7, 'Should render 7 day columns');
        const todayISO = new Date().toISOString().slice(0,10);
        saveNames(todayISO, 'day', ['Test User']);
        const loaded = loadNames(todayISO, 'day');
        console.assert(Array.isArray(loaded) && loaded.includes('Test User'), 'Storage load/save failed');
        const enc = `${todayISO}|night`; const [d1, s1] = enc.split('|'); console.assert(d1 === todayISO && s1 === 'night', 'Choice parsing failed');
        console.groupEnd();
      } catch(e) { console.error('Tests failed', e); }
    })();
  </script>
</body>
</html>
