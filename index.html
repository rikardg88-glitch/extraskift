<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>7‑Day Work Shift Calendar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="description" content="7‑day work calendar with QR signup via Google Form and live names from Google Sheet. No local storage. Mobile friendly. Ready for GitHub Pages." />
  <style>
    html, body { height: 100%; }
    .card { box-shadow: 0 10px 25px rgba(0,0,0,.08); }
  </style>
</head>
<body class="min-h-full bg-slate-50 text-slate-800">
  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-2xl font-semibold">7‑Day Work Shift Calendar</h1>
      <nav class="flex items-center gap-2 text-sm">
        <button id="refreshBtn" class="px-3 py-1.5 rounded-lg bg-slate-900 text-white hover:opacity-90">Refresh</button>
        <button id="shareBtn" class="px-3 py-1.5 rounded-lg bg-slate-200 hover:bg-slate-300">Copy page link</button>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <section id="tips" class="hidden mb-4 rounded-xl border border-amber-300 bg-amber-50 text-amber-900 p-4 text-sm"></section>
    <section class="mb-6 text-sm text-slate-600">
      <p>This version works fully online: QR codes open your form; names are read live from your Google Sheet. No local storage. Phones and desktop supported.</p>
    </section>

    <section id="calendar" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></section>
  </main>

  <!-- QRCode library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" integrity="sha512-Mn6G2P0CBN1VYcFv9Jr8kZzuWCFdYbQOqXgQYzqU8W0nI/W2cs8s3kA3+1a9C3b5x7E1F3vJ9Eo0v4C2Qb9u0w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
    // ============================
    // CONFIG — replace these with your own
    // ============================
    const TIMEZONE = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Europe/Oslo';

    // 1) Google Form URL to open from QR (plain view link is fine). If you have a pre‑filled template, paste that here instead.
    //    If you paste a true pre‑filled template that contains placeholders or entry.x ids, the app will try to fill date/shift.
    const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfhxqHshc0-MtuAReM5JOyxdXpuj_S6CZvOPgcKVuV2HlzVfQ/viewform?usp=pp_url";

    // 2) Google Sheet (Responses) — make it public (Anyone with link: Viewer) or File → Share → Publish to web
    //    Use your Sheet ID and the tab gid that contains responses.
    const SHEET_ID = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4_xMK3RWlxzpArD6Dv_98Y5cQVwOIH4Uj-wxL2v3sISD7YAD_WOBgA5rtRrBrAsG8Unna9NsqAGuk/pubhtml"; // change if different
    const SHEET_GID = "0"; // change if your responses tab is not gid=0

    // If you PUBLISH the sheet, you can also use the CSV endpoint below (often a bit faster):
    const USE_GVIZ = true; // set false to use published CSV endpoint

    // Optional: If you created a genuine pre‑filled template with placeholders, set them here so we can swap values.
    // Example placeholders you used while generating the pre‑filled link: __NAME__, 01/01/2030, __SHIFT__
    const PREFILLED_TEMPLATE = ""; // paste your pre‑filled template URL (with placeholders) if you have one
    const PLACEHOLDERS = { NAME: "__NAME__", DATE: "01/01/2030", SHIFT: "__SHIFT__" };

    // ============================
    // Shift definitions
    // ============================
    const SHIFTS_MON_THU = [
      { key: 'day', label: 'Day', time: '07:00–15:00' },
      { key: 'afternoon', label: 'Afternoon', time: '15:00–23:00' },
      { key: 'night', label: 'Night', time: '23:00–07:00' },
    ];
    const SHIFTS_FRI_SUN = [
      { key: 'day', label: 'Day', time: '08:00–20:00' },
      { key: 'night', label: 'Night', time: '20:00–08:00' },
    ];

    // ============================
    // Helpers
    // ============================
    const pad = n => (n < 10 ? '0' + n : '' + n);
    const toISODate = d => [d.getFullYear(), pad(d.getMonth()+1), pad(d.getDate())].join('-');
    const formatHuman = d => new Intl.DateTimeFormat(undefined, { weekday: 'long', month: 'short', day: 'numeric', timeZone: TIMEZONE }).format(d);
    const getNext7Days = () => Array.from({length:7}, (_,i)=>{ const d=new Date(); d.setDate(d.getDate()+i); return d; });
    const shiftsForDate = d => ([1,2,3,4].includes(d.getDay()) ? SHIFTS_MON_THU : SHIFTS_FRI_SUN);

    function toDDMMYYYY(dateISO){ const [y,m,d]=dateISO.split('-'); return `${d}/${m}/${y}`; }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    function normalizeShift(value){
      const v = String(value||'').trim().toLowerCase();
      if (["day","dag","dagvakt"].includes(v)) return 'day';
      if (["afternoon","evening","ettermiddag","aft"].includes(v)) return 'afternoon';
      if (["night","natt","nightshift"].includes(v)) return 'night';
      return null;
    }

    function parseToISO(mixed){
      if (!mixed) return null; const s = String(mixed).trim();
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s; // YYYY-MM-DD
      let m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/); // DD/MM/YYYY
      if (m) { const [_,d,mo,y]=m; return `${y}-${pad(+mo)}-${pad(+d)}`; }
      m = s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/); // DD.MM.YYYY
      if (m) { const [_,d,mo,y]=m; return `${y}-${pad(+mo)}-${pad(+d)}`; }
      const dt = new Date(s); if (!isNaN(dt)) return toISODate(dt);
      return null;
    }

    function buildFormURL(dateISO, shiftKey){
      // If a proper pre‑filled template exists, fill it; otherwise just use FORM_URL
      if (PREFILLED_TEMPLATE && /__SHIFT__|01\/01\/2030|entry\./.test(PREFILLED_TEMPLATE)){
        const shift = (SHIFTS_MON_THU.concat(SHIFTS_FRI_SUN)).find(s=>s.key===shiftKey);
        const ddmmyyyy = toDDMMYYYY(dateISO);
        return PREFILLED_TEMPLATE
          .replace(PLACEHOLDERS.DATE, encodeURIComponent(ddmmyyyy))
          .replace(PLACEHOLDERS.SHIFT, encodeURIComponent(shift ? shift.label : shiftKey))
          .replace(PLACEHOLDERS.NAME, ""); // name left blank for the user to fill
      }
      return FORM_URL;
    }

    // ============================
    // Fetch signups from Google Sheet
    // ============================
    const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${SHEET_GID}&tqx=out:json`;
    const CSV_URL  = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/pub?gid=${SHEET_GID}&single=true&output=csv`;

    async function fetchFromGViz(){
      const res = await fetch(GVIZ_URL, { cache:'no-store' });
      const text = await res.text();
      const json = JSON.parse(text.replace(/^.*setResponse\(/, '').replace(/\);?\s*$/, ''));
      const table = json.table;
      const labels = (table.cols || []).map(c => (c && c.label ? c.label.toLowerCase().trim() : ''));
      const idxName  = labels.findIndex(l => ["name","navn"].includes(l));
      const idxDate  = labels.findIndex(l => ["date","dato"].includes(l));
      const idxShift = labels.findIndex(l => ["shift","vakt"].includes(l));
      const signups = {}; // { [dateISO]: { [shiftKey]: [names...] } }
      for (const row of (table.rows || [])){
        const c = row.c || [];
        const name = c[idxName]?.v || c[idxName]?.f || '';
        const rawDate = c[idxDate]?.v || c[idxDate]?.f || '';
        const rawShift = c[idxShift]?.v || c[idxShift]?.f || '';
        const dateISO = parseToISO(rawDate);
        const shiftKey = normalizeShift(rawShift);
        const cleanName = String(name).trim();
        if (dateISO && shiftKey && cleanName){
          (signups[dateISO] ||= {});
          (signups[dateISO][shiftKey] ||= []);
          if (!signups[dateISO][shiftKey].includes(cleanName)) signups[dateISO][shiftKey].push(cleanName);
        }
      }
      return signups;
    }

    async function fetchFromCSV(){
      const res = await fetch(CSV_URL, { cache:'no-store' });
      const text = await res.text();
      // Simple CSV parse (no quotes handling edge cases). Expect headers: Name,Date,Shift (or Norwegian equivalents)
      const rows = text.split(/\r?\n/).filter(Boolean).map(r => r.split(','));
      const header = rows.shift().map(h => h.trim().toLowerCase());
      const idxName  = header.findIndex(l => ["name","navn"].includes(l));
      const idxDate  = header.findIndex(l => ["date","dato"].includes(l));
      const idxShift = header.findIndex(l => ["shift","vakt"].includes(l));
      const signups = {};
      for (const r of rows){
        const name = r[idxName] || '';
        const rawDate = r[idxDate] || '';
        const rawShift = r[idxShift] || '';
        const dateISO = parseToISO(rawDate);
        const shiftKey = normalizeShift(rawShift);
        const cleanName = String(name).trim();
        if (dateISO && shiftKey && cleanName){
          (signups[dateISO] ||= {});
          (signups[dateISO][shiftKey] ||= []);
          if (!signups[dateISO][shiftKey].includes(cleanName)) signups[dateISO][shiftKey].push(cleanName);
        }
      }
      return signups;
    }

    async function fetchSignups(){
      try {
        return USE_GVIZ ? await fetchFromGViz() : await fetchFromCSV();
      } catch (e){
        showTip("Could not read the Google Sheet. Make sure it is public (Anyone with link: Viewer) or use File → Share → Publish to web. Also confirm the correct <code>SHEET_GID</code>.");
        console.warn(e);
        return {};
      }
    }

    function showTip(html){
      const el = document.getElementById('tips');
      el.innerHTML = html; el.classList.remove('hidden');
    }

    // ============================
    // Render calendar
    // ============================
    function buildDayCard(dateObj, signups){
      const dateISO = toISODate(dateObj);
      const human = formatHuman(dateObj);
      const shifts = shiftsForDate(dateObj);
      const dayData = signups[dateISO] || {};

      const wrap = document.createElement('article');
      wrap.className = 'card rounded-2xl bg-white p-4';
      wrap.innerHTML = `
        <div class="flex items-baseline justify-between mb-3">
          <div>
            <div class="text-sm text-slate-500">${dateISO}</div>
            <h3 class="text-lg font-semibold">${human}</h3>
          </div>
        </div>
        <div class="space-y-3"></div>
      `;

      const list = wrap.querySelector('.space-y-3');
      shifts.forEach(shift => {
        const id = `${dateISO}_${shift.key}`;
        const names = dayData[shift.key] || [];
        const link = buildFormURL(dateISO, shift.key);

        const el = document.createElement('div');
        el.className = 'rounded-xl border border-slate-200 p-3';
        el.innerHTML = `
          <div class="flex items-start justify-between">
            <div>
              <div class="font-medium">${shift.label} shift</div>
              <div class="text-xs text-slate-500">${shift.time}</div>
            </div>
            <div class="flex items-center gap-2">
              <button class="text-xs px-2 py-1 rounded-lg bg-slate-100 hover:bg-slate-200" data-copy="${link}">Copy link</button>
              <a class="text-xs px-2 py-1 rounded-lg bg-slate-900 text-white hover:opacity-90" href="${link}" target="_blank" rel="noopener">Open</a>
              <div id="qr_${id}" class="w-[96px] h-[96px] border border-slate-200 rounded-lg overflow-hidden bg-white"></div>
            </div>
          </div>
          <div class="mt-2 text-sm">
            <div class="text-slate-500">Signed up:</div>
            ${Array.isArray(names) && names.length ? `<ul class="mt-1 list-disc list-inside">${names.map(n=>`<li>${escapeHtml(n)}</li>`).join('')}</ul>` : '<div class="text-slate-400">(no one yet)</div>'}
          </div>
        `;
        list.appendChild(el);

        new QRCode(document.getElementById(`qr_${id}`), {
          text: link,
          width: 96,
          height: 96,
          correctLevel: QRCode.CorrectLevel.M,
        });
      });

      return wrap;
    }

    async function renderCalendar(){
      const root = document.getElementById('calendar');
      root.innerHTML = '';
      const signups = await fetchSignups();
      getNext7Days().forEach(d => root.appendChild(buildDayCard(d, signups)));
      attachCopyHandlers();
    }

    function attachCopyHandlers(){
      document.querySelectorAll('[data-copy]').forEach(btn => {
        btn.addEventListener('click', async ()=>{
          const url = btn.getAttribute('data-copy');
          try { await navigator.clipboard.writeText(url); const t=btn.textContent; btn.textContent='Copied!'; setTimeout(()=>btn.textContent=t,1200); }
          catch { alert('Copy failed. URL: '+url); }
        });
      });
    }

    // ============================
    // Init
    // ============================
    document.getElementById('refreshBtn').addEventListener('click', renderCalendar);
    document.getElementById('shareBtn').addEventListener('click', async ()=>{
      try { await navigator.clipboard.writeText(location.href.split('?')[0]); alert('Copied page link'); } catch { alert('Copy failed'); }
    });

    renderCalendar();
  </script>

  <!--
  ==========================================
  📌 Deploy to GitHub Pages (no build tools)
  ==========================================
  1) Put this file in a repo as index.html
  2) Settings → Pages → Deploy from branch
  3) Open the live URL. It works on phones & desktop.

  ✅ Make sure the Sheet is readable
  - Share the sheet: Anyone with the link → Viewer, OR
  - File → Share → Publish to web (then USE_GVIZ=false to fetch CSV)

  ✅ Optional: true pre‑filled Form URLs
  - Create a pre‑filled link (⋮ → Get pre‑filled link). Use placeholders like __NAME__, 01/01/2030, __SHIFT__.
  - Paste into PREFILLED_TEMPLATE to auto-fill date/shift in the form opened by the QR.
  -->
</body>
</html>
